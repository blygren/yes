<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Camera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“·</text></svg>">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; color: #333; text-align: center; padding: 1em; margin: 0; }
        h1 { color: #111; }
        video { background-color: black; width: 100%; max-width: 800px; border-radius: 8px; margin-top: 1em; }
        #local-video { display: none; }
        #status { font-size: 1.2em; margin: 1em 0; min-height: 1.5em; }
        #qr-container { background-color: white; padding: 20px; display: inline-block; border-radius: 8px; margin-top: 1em; }
        button { background-color: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1.2em; cursor: pointer; margin: 0.5em; }
        button:hover { background-color: #0056b3; }
        #initial-choice, #viewer-ui, #camera-ui { display: none; }
        #reader { width: 90%; max-width: 500px; margin: 1em auto; border: 2px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Web Camera</h1>
    <div id="status">Initializing...</div>

    <!-- Initial Role Selection -->
    <div id="initial-choice">
        <button id="become-viewer-btn">Become Viewer (PC)</button>
        <button id="become-camera-btn">Become Camera (Phone)</button>
    </div>

    <!-- Viewer UI (PC) -->
    <div id="viewer-ui">
        <h2>PC (Viewer)</h2>
        <p>Scan this QR code with your phone to connect.</p>
        <div id="qr-container"></div>
    </div>

    <!-- Camera UI (Phone) -->
    <div id="camera-ui">
        <h2>Phone (Camera)</h2>
        <div id="reader"></div>
        <p>Your camera view (will appear after connecting):</p>
        <video id="local-video" autoplay muted playsinline></video>
    </div>

    <!-- Remote video display -->
    <video id="remote-video" autoplay playsinline></video>

    <script>
        const statusEl = document.getElementById('status');
        const initialChoiceUi = document.getElementById('initial-choice');
        const viewerUi = document.getElementById('viewer-ui');
        const cameraUi = document.getElementById('camera-ui');
        const qrContainer = document.getElementById('qr-container');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const becomeViewerBtn = document.getElementById('become-viewer-btn');
        const becomeCameraBtn = document.getElementById('become-camera-btn');

        let peer = null;
        let currentCall = null;
        let html5QrCode = null;

        const peerConfig = {
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun.services.mozilla.com' },
                ]
            }
        };

        function initialize() {
            const urlParams = new URLSearchParams(window.location.search);
            const remotePeerId = urlParams.get('id');

            if (remotePeerId) {
                // URL has an ID, so this must be the camera.
                startCamera(remotePeerId);
            } else {
                // No ID in URL, show choice.
                initialChoiceUi.style.display = 'block';
                statusEl.textContent = 'Choose your role.';
            }
        }

        becomeViewerBtn.addEventListener('click', () => {
            initialChoiceUi.style.display = 'none';
            viewerUi.style.display = 'block';
            remoteVideo.style.display = 'none';
            statusEl.textContent = 'Waiting for connection...';

            peer = new Peer(peerConfig);
            peer.on('open', id => {
                const connectUrl = `${window.location.origin}${window.location.pathname}?id=${id}`;
                new QRCode(qrContainer, {
                    text: connectUrl,
                    width: 256,
                    height: 256,
                });
                statusEl.textContent = 'Viewer ready. Scan QR code with phone.';
            });

            peer.on('call', call => {
                currentCall = call;
                statusEl.textContent = 'Connected!';
                viewerUi.style.display = 'none';
                remoteVideo.style.display = 'block';
                
                call.on('stream', remoteStream => {
                    remoteVideo.srcObject = remoteStream;
                });

                call.on('close', () => {
                    statusEl.textContent = 'Connection closed. Refresh to start over.';
                    remoteVideo.style.display = 'none';
                    viewerUi.style.display = 'block';
                });
            });

            peer.on('error', handleError);
        });

        becomeCameraBtn.addEventListener('click', () => {
            initialChoiceUi.style.display = 'none';
            cameraUi.style.display = 'block';
            statusEl.textContent = 'Use camera to scan QR code from viewer screen.';
            html5QrCode = new Html5Qrcode("reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                html5QrCode.stop().then(() => {
                    window.location.href = decodedText;
                }).catch(err => console.error("Failed to stop scanner", err));
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => handleError(new Error("Could not start QR scanner.")));
        });

        async function startCamera(remotePeerId) {
            initialChoiceUi.style.display = 'none';
            viewerUi.style.display = 'none';
            cameraUi.style.display = 'block';
            document.getElementById('reader').style.display = 'none'; // Hide scanner
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                localVideo.srcObject = stream;
                localVideo.style.display = 'block';

                peer = new Peer(peerConfig);
                peer.on('open', () => {
                    statusEl.textContent = `Connecting to viewer...`;
                    currentCall = peer.call(remotePeerId, stream);
                    
                    if (!currentCall) {
                        handleError(new Error("Could not establish call. Please ensure viewer is ready."));
                        return;
                    }

                    currentCall.on('close', () => {
                        statusEl.textContent = 'Connection closed.';
                        localVideo.style.display = 'none';
                    });
                });
                
                peer.on('error', handleError);

            } catch (err) {
                handleError(err);
            }
        }

        function handleError(err) {
            console.error(err);
            statusEl.textContent = `Error: ${err.message}. Please refresh and try again.`;
            if (html5QrCode) {
                html5QrCode.stop().catch(e => {});
            }
        }

        initialize();
    </script>
</body>
</html>
