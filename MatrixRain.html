<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Rain</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
        }

        #matrix-canvas {
            display: block;
        }

        #settings-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(50, 50, 50, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: sans-serif;
            width: 320px;
            box-sizing: border-box;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            border: 1px solid #444;
        }

        #settings-panel.minimized {
            /* Hide all but 45px (button + padding) */
            transform: translateX(calc(100% - 45px));
        }

        #settings-panel.minimized #panel-content {
            display: none;
        }

        #panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        #panel-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        #toggle-panel {
            background: #444;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 22px;
            text-align: center;
        }

        #panel-content {
            margin-top: 15px;
        }

        .setting {
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            font-size: 0.9em;
        }

        .setting label {
            flex-basis: 120px;
        }

        .setting input[type="color"],
        .setting input[type="text"],
        .setting select {
            flex: 1;
            background: #222;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px;
            box-sizing: border-box;
        }

        .setting input[type="range"] {
            flex: 1;
            margin: 0 5px;
        }

        .setting input[type="checkbox"] {
            margin-right: 5px;
        }

        .sub-setting {
            flex-basis: 100%;
            margin-left: 120px;
            margin-top: 5px;
        }

        #reset-button {
            width: 100%;
            padding: 8px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        #reset-button:hover {
            background: #e74c3c;
        }

        #custom-text-input {
            margin-top: 8px;
            flex-basis: 100%;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            #settings-panel {
                width: 100%;
                top: auto;
                bottom: 0;
                right: 0;
                border-radius: 8px 8px 0 0;
                border-width: 1px 0 0 0;
            }

            #settings-panel.minimized {
                /* Show only the header */
                transform: translateY(calc(100% - 55px));
            }

            .setting label {
                flex-basis: 100px;
            }
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>

    <div id="settings-panel">
        <div id="panel-header">
            <h2>Settings</h2>
            <button id="toggle-panel">-</button>
        </div>
        <div id="panel-content">
            <div class="setting">
                <label for="text-select">Characters:</label>
                <select id="text-select">
                    <option value="katakana">Katakana</option>
                    <option value="binary">Binary</option>
                    <option value="ascii">ASCII</option>
                    <option value="numbers">Numbers</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="text" id="custom-text-input" value="MATRIX" style="display:none;">
            </div>
            <div class="setting">
                <label for="color-picker">Text Color:</label>
                <input type="color" id="color-picker" value="#00FF41">
            </div>
            <div class="setting">
                <label for="highlight-color-picker">Highlight Color:</label>
                <input type="color" id="highlight-color-picker" value="#FFFFFF">
            </div>
            <div class="setting">
                <label for="bg-color-picker">Background Color:</label>
                <input type="color" id="bg-color-picker" value="#000000">
            </div>
            <div class="setting">
                <label for="font-size-slider">Font Size:</label>
                <input type="range" id="font-size-slider" min="5" max="30" value="15">
                <span id="font-size-value">15</span>
            </div>
            <div class="setting">
                <label for="speed-slider">Speed (FPS):</label>
                <input type="range" id="speed-slider" min="1" max="60" value="10">
                <span id="speed-value">10</span>
            </div>
            <div class="setting">
                <label for="speed-variation-slider">Speed Variation:</label>
                <input type="range" id="speed-variation-slider" min="0" max="100" value="20">
                <span id="speed-variation-value">0.2</span>
            </div>
             <div class="setting">
                <label for="fade-slider">Fade Amount:</label>
                <input type="range" id="fade-slider" min="1" max="50" value="10">
                 <span id="fade-value">0.10</span>
            </div>
            <div class="setting">
                <label for="glow-toggle">Glow Effect:</label>
                <input type="checkbox" id="glow-toggle" checked>
                <input type="range" id="glow-blur-slider" min="0" max="20" value="5" class="sub-setting">
            </div>
            <div class="setting">
                <label for="direction-select">Direction:</label>
                <select id="direction-select">
                    <option value="down">Down</option>
                    <option value="up">Up</option>
                </select>
            </div>
            <div class="setting">
                <button id="reset-button">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- Default Settings ---
        const defaultSettings = {
            text: 'katakana',
            customText: 'MATRIX',
            color: '#00FF41',
            highlightColor: '#FFFFFF',
            backgroundColor: '#000000',
            fontSize: 15,
            speed: 10, // frames per second
            fadeAmount: 0.1,
            glow: true,
            glowBlur: 5,
            direction: 'down',
            speedVariation: 0.2,
        };

        // --- Live Settings ---
        let settings = { ...defaultSettings };

        let katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        let binary = '01';
        let ascii = '!"#$%&\'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~';
        let numbers = '0123456789';
        let characters = katakana;

        let columns;
        let drops;
        let dropSpeeds;

        function initialize() {
            characters = getCharacterString();
            const isVertical = settings.direction === 'down' || settings.direction === 'up';
            columns = isVertical 
                ? Math.floor(canvas.width / settings.fontSize)
                : Math.floor(canvas.height / settings.fontSize); // Rows for horizontal
            drops = [];
            dropSpeeds = [];
            for (let i = 0; i < columns; i++) {
                if (settings.direction === 'down') drops[i] = 1;
                else if (settings.direction === 'up') drops[i] = Math.floor(Math.random() * canvas.height / settings.fontSize);
                else drops[i] = 1; // For 'left' and 'right'
                
                dropSpeeds[i] = 1 + (Math.random() - 0.5) * settings.speedVariation;
            }
        }

        function getCharacterString() {
            switch (settings.text) {
                case 'binary': return binary;
                case 'ascii': return ascii;
                case 'numbers': return numbers;
                case 'custom': return settings.customText || ' ';
                case 'katakana': default: return katakana;
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return { r: 0, g: 0, b: 0 };
            return {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            };
        }

        let lastTime = 0;
        let timer = 0;

        function draw(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            const interval = 1000 / settings.speed;

            if (timer > interval) {
                const rgb = hexToRgb(settings.backgroundColor);
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${settings.fadeAmount})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (settings.glow) {
                    ctx.shadowColor = settings.color;
                    ctx.shadowBlur = settings.glowBlur;
                } else {
                    ctx.shadowBlur = 0;
                }

                ctx.font = settings.fontSize + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    
                    const y = drops[i] * settings.fontSize;

                    // Highlight first character
                    const isHighlighted = (settings.direction === 'down' && y < settings.fontSize * 2) ||
                                          (settings.direction === 'up' && y > canvas.height - settings.fontSize * 2);

                    if (isHighlighted) {
                         ctx.fillStyle = settings.highlightColor;
                    } else {
                        ctx.fillStyle = settings.color;
                    }

                    ctx.fillText(text, i * settings.fontSize, y);

                    const dropSpeed = dropSpeeds[i] || 1;
                    if (settings.direction === 'down') {
                        if (y > canvas.height && Math.random() > 0.975) {
                            drops[i] = 0;
                        }
                        drops[i] += dropSpeed;
                    } else { // up
                        if (y < 0 && Math.random() > 0.975) {
                            drops[i] = canvas.height / settings.fontSize;
                        }
                        drops[i] -= dropSpeed;
                    }
                }
                timer = 0;
            } else {
                timer += deltaTime;
            }

            requestAnimationFrame(draw);
        }

        // --- Settings Panel Logic ---
        const textSelect = document.getElementById('text-select');
        const customTextInput = document.getElementById('custom-text-input');
        const colorPicker = document.getElementById('color-picker');
        const highlightColorPicker = document.getElementById('highlight-color-picker');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const speedVariationSlider = document.getElementById('speed-variation-slider');
        const speedVariationValue = document.getElementById('speed-variation-value');
        const fadeSlider = document.getElementById('fade-slider');
        const fadeValue = document.getElementById('fade-value');
        const glowToggle = document.getElementById('glow-toggle');
        const glowBlurSlider = document.getElementById('glow-blur-slider');
        const directionSelect = document.getElementById('direction-select');
        const resetButton = document.getElementById('reset-button');
        const togglePanelBtn = document.getElementById('toggle-panel');
        const settingsPanel = document.getElementById('settings-panel');
        const panelHeader = document.getElementById('panel-header');

        function updateUIFromSettings() {
            textSelect.value = settings.text;
            customTextInput.value = settings.customText;
            customTextInput.style.display = (settings.text === 'custom') ? 'block' : 'none';
            colorPicker.value = settings.color;
            highlightColorPicker.value = settings.highlightColor;
            bgColorPicker.value = settings.backgroundColor;
            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = settings.fontSize;
            speedSlider.value = settings.speed;
            speedValue.textContent = settings.speed;
            speedVariationSlider.value = settings.speedVariation * 100;
            speedVariationValue.textContent = settings.speedVariation.toFixed(1);
            fadeSlider.value = settings.fadeAmount * 100;
            fadeValue.textContent = settings.fadeAmount.toFixed(2);
            glowToggle.checked = settings.glow;
            glowBlurSlider.value = settings.glowBlur;
            glowBlurSlider.style.display = settings.glow ? 'block' : 'none';
            directionSelect.value = settings.direction;
        }

        // Event Listeners
        textSelect.addEventListener('change', (e) => {
            settings.text = e.target.value;
            customTextInput.style.display = (settings.text === 'custom') ? 'block' : 'none';
            initialize();
        });

        customTextInput.addEventListener('input', (e) => {
            settings.customText = e.target.value;
            if (settings.text === 'custom') {
                initialize();
            }
        });

        colorPicker.addEventListener('input', (e) => { settings.color = e.target.value; });
        highlightColorPicker.addEventListener('input', (e) => { settings.highlightColor = e.target.value; });

        bgColorPicker.addEventListener('input', (e) => {
            settings.backgroundColor = e.target.value;
            const rgb = hexToRgb(settings.backgroundColor);
            ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        fontSizeSlider.addEventListener('input', (e) => {
            settings.fontSize = parseInt(e.target.value);
            fontSizeValue.textContent = settings.fontSize;
            initialize();
        });

        speedSlider.addEventListener('input', (e) => {
            settings.speed = parseInt(e.target.value);
            speedValue.textContent = settings.speed;
        });

        speedVariationSlider.addEventListener('input', (e) => {
            settings.speedVariation = parseInt(e.target.value) / 100;
            speedVariationValue.textContent = settings.speedVariation.toFixed(1);
            initialize();
        });

        fadeSlider.addEventListener('input', (e) => {
            settings.fadeAmount = parseInt(e.target.value) / 100;
            fadeValue.textContent = settings.fadeAmount.toFixed(2);
        });

        glowToggle.addEventListener('change', (e) => {
            settings.glow = e.target.checked;
            glowBlurSlider.style.display = settings.glow ? 'block' : 'none';
        });

        glowBlurSlider.addEventListener('input', (e) => {
            settings.glowBlur = parseInt(e.target.value);
        });

        directionSelect.addEventListener('change', (e) => {
            settings.direction = e.target.value;
            initialize();
        });

        resetButton.addEventListener('click', () => {
            settings = { ...defaultSettings };
            updateUIFromSettings();
            initialize();
        });

        togglePanelBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('minimized');
            togglePanelBtn.textContent = settingsPanel.classList.contains('minimized') ? '+' : '-';
        });

        panelHeader.addEventListener('click', (e) => {
            if (e.target === panelHeader || e.target.tagName === 'H2') {
                togglePanelBtn.click();
            }
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initialize();
        });

        // --- Initial Setup ---
        function start() {
            const initialRgb = hexToRgb(settings.backgroundColor);
            ctx.fillStyle = `rgba(${initialRgb.r}, ${initialRgb.g}, ${initialRgb.b}, 1)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            updateUIFromSettings();

            initialize();
            requestAnimationFrame(draw);
        }

        start();
    </script>
</body>
</html>
