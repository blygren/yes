<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Video Call</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; }
        h1, h2 { text-align: center; }
        .container { display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .video-wrapper { width: 100%; max-width: 360px; margin: 0 10px 20px; position: relative; }
        video { width: 100%; border-radius: 8px; background-color: #000; cursor: pointer; }
        .controls { background-color: #fff; padding: 20px; border-radius: 8px; margin-top: 20px; max-width: 760px; margin-left: auto; margin-right: auto; }
        textarea { width: 100%; height: 100px; margin-top: 5px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; padding: 8px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-top: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        hr { border: 0; height: 1px; background-color: #ddd; margin: 20px 0; }
        p { margin-top: 0; }
    </style>
</head>
<body>

    <h1>WebRTC P2P Video Call</h1>

    <div class="container">
        <div class="video-wrapper">
            <h2>You</h2>
            <video id="localVideo" autoplay muted playsinline title="Click to toggle fullscreen" onclick="toggleFullscreen(this)"></video>
        </div>
        <div class="video-wrapper">
            <h2>Friend</h2>
            <video id="remoteVideo" autoplay playsinline title="Click to toggle fullscreen" onclick="toggleFullscreen(this)"></video>
        </div>
    </div>

    <div class="controls">
        <button id="startButton">1. Start Camera</button>
        <button id="beepButton" disabled>Beep Friend</button>
        <hr>
        
        <h2>For Caller</h2>
        <p>Click to generate an offer and send it to your friend.</p>
        <button id="createOfferButton" disabled>2. Create Offer</button>
        <textarea id="offerSdp" readonly placeholder="Offer will appear here..."></textarea>
        <p>Paste the answer from your friend below and add it.</p>
        <textarea id="answerSdpPaste" placeholder="Paste answer here..."></textarea>
        <button id="addAnswerButton" disabled>4. Add Answer</button>

        <hr>

        <h2>For Receiver</h2>
        <p>Paste the offer from your friend below.</p>
        <textarea id="offerSdpPaste" placeholder="Paste offer here..."></textarea>
        <button id="createAnswerButton" disabled>3. Create Answer</button>
        <p>Send the generated answer back to the caller.</p>
        <textarea id="answerSdpResponse" readonly placeholder="Answer will appear here..."></textarea>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const createOfferButton = document.getElementById('createOfferButton');
        const createAnswerButton = document.getElementById('createAnswerButton');
        const addAnswerButton = document.getElementById('addAnswerButton');
        const beepButton = document.getElementById('beepButton');
        
        const offerSdp = document.getElementById('offerSdp');
        const answerSdpPaste = document.getElementById('answerSdpPaste');
        const offerSdpPaste = document.getElementById('offerSdpPaste');
        const answerSdpResponse = document.getElementById('answerSdpResponse');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        let localStream;
        let peerConnection;
        let dataChannel;
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        async function start() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                createOfferButton.disabled = false;
                createAnswerButton.disabled = false;
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        }

        function setupDataChannel(pc) {
            pc.ondatachannel = (event) => {
                dataChannel = event.channel;
                setDataChannelEvents(dataChannel);
                peerConnection.ondatachannel = null; // Prevent this from firing again
            };
        }

        function setDataChannelEvents(channel) {
            channel.onopen = () => {
                console.log('Data channel is open');
                beepButton.disabled = false;
            };
            channel.onclose = () => {
                console.log('Data channel is closed');
                beepButton.disabled = true;
            };
            channel.onmessage = (event) => {
                if (event.data === 'beep') {
                    playBeep();
                }
            };
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        async function createOffer() {
            createPeerConnection();
            dataChannel = peerConnection.createDataChannel('beepChannel');
            setDataChannelEvents(dataChannel);

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Wait for ICE gathering to complete
            await new Promise(resolve => {
                if (peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    peerConnection.onicecandidate = event => {
                        if (!event.candidate) {
                            peerConnection.onicecandidate = null;
                            resolve();
                        }
                    };
                }
            });

            offerSdp.value = JSON.stringify(peerConnection.localDescription);
            createOfferButton.disabled = true;
            addAnswerButton.disabled = false;
        }

        async function createAnswer() {
            if (!offerSdpPaste.value) {
                alert('Please paste the offer from the caller first.');
                return;
            }
            
            let offer;
            try {
                offer = JSON.parse(offerSdpPaste.value);
            } catch (e) {
                alert('Invalid offer format. Please paste the correct offer.');
                return;
            }

            createPeerConnection();
            setupDataChannel(peerConnection);

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // Wait for ICE gathering to complete
            await new Promise(resolve => {
                if (peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    peerConnection.onicecandidate = event => {
                        if (!event.candidate) {
                            peerConnection.onicecandidate = null;
                            resolve();
                        }
                    };
                }
            });

            answerSdpResponse.value = JSON.stringify(peerConnection.localDescription);
            createAnswerButton.disabled = true;
        }

        async function addAnswer() {
            if (!answerSdpPaste.value) {
                alert('Please paste the answer from the receiver first.');
                return;
            }
            
            let answer;
            try {
                answer = JSON.parse(answerSdpPaste.value);
            } catch (e) {
                alert('Invalid answer format. Please paste the correct answer.');
                return;
            }

            if (!peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
            addAnswerButton.disabled = true;
        }

        function playBeep() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);

            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);

            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
        }

        function toggleFullscreen(element) {
            if (!document.fullscreenElement) {
                element.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        startButton.onclick = start;
        createOfferButton.onclick = createOffer;
        createAnswerButton.onclick = createAnswer;
        addAnswerButton.onclick = addAnswer;
        beepButton.onclick = () => {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send('beep');
            }
        };
    </script>

</body>
</html>